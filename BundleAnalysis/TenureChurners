WITH 

CHURNERSSO AS
(SELECT DISTINCT RIGHT(CONCAT('0000000000',NOMBRE_CONTRATO) ,10) AS CONTRATOSO, Min(FECHA_APERTURA) AS FECHA_APERTURA,
 FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-01-12_CR_ORDENES_SERVICIO_2021-01_A_2021-11_D`
 WHERE
  TIPO_ORDEN = "DESINSTALACION" 
  AND (ESTADO <> "CANCELADA" OR ESTADO <> "ANULADA")
 AND FECHA_APERTURA IS NOT NULL
 GROUP BY CONTRATOSO
 ),

CHURNERSSOCLASIF AS
(SELECT DISTINCT RIGHT(CONCAT('0000000000',NOMBRE_CONTRATO) ,10) AS CONTRATOSO, Min(t.FECHA_APERTURA) AS FECHA_APERTURA,
CASE WHEN SUBMOTIVO = "MOROSIDAD" THEN RIGHT(CONCAT('0000000000',NOMBRE_CONTRATO) ,10) END AS INVOLUNTARIO,
CASE WHEN SUBMOTIVO <> "MOROSIDAD" THEN RIGHT(CONCAT('0000000000',NOMBRE_CONTRATO) ,10) END AS VOLUNTARIO
 FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-01-12_CR_ORDENES_SERVICIO_2021-01_A_2021-11_D` t
 INNER JOIN CHURNERSSO s ON RIGHT(CONCAT('0000000000',t.NOMBRE_CONTRATO) ,10)= s.CONTRATOSO AND t.FECHA_APERTURA = s.FECHA_APERTURA
 WHERE
  TIPO_ORDEN = "DESINSTALACION" 
  AND (ESTADO <> "CANCELADA" OR ESTADO <> "ANULADA")
 AND t.FECHA_APERTURA IS NOT NULL
 GROUP BY CONTRATOSO, INVOLUNTARIO, VOLUNTARIO
 ),

CHURNERSCRM AS(
  SELECT DISTINCT RIGHT(CONCAT('0000000000',ACT_ACCT_CD) ,10) AS CONTRATOCRM, MAX(DATE(CST_CHRN_DT)) AS Maxfecha,Extract(Month from Max(CST_CHRN_DT)) AS MesChurnF
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-16_FINAL_HISTORIC_CRM_FILE_2021_D`
    GROUP BY ACT_ACCT_CD
    HAVING EXTRACT (MONTH FROM Maxfecha) = EXTRACT (MONTH FROM MAX(FECHA_EXTRACCION))
),
FIRSTCHURN AS(
 SELECT DISTINCT RIGHT(CONCAT('0000000000',ACT_ACCT_CD) ,10) AS CONTRATOPCHURN, Min(DATE(CST_CHRN_DT)) AS PrimerChurn, Extract(Month from Min(CST_CHRN_DT)) AS MesChurnP
    FROM  `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-16_FINAL_HISTORIC_CRM_FILE_2021_D`
    GROUP BY ACT_ACCT_CD
    HAVING EXTRACT (YEAR FROM PrimerChurn) = 2021
),
REALCHURNERS AS(
 SELECT DISTINCT CONTRATOCRM AS CHURNER, MaxFecha, PrimerChurn, MesChurnF, MesChurnP
 FROM CHURNERSCRM c  INNER JOIN FIRSTCHURN f ON c.CONTRATOCRM = f.CONTRATOPCHURN AND f.PrimerChurn <= c.MaxFecha
   GROUP BY CHURNER, MaxFecha, PrimerChurn, MesChurnF, MesChurnP),

CRUCECHURNERS AS(
SELECT CONTRATOSO, CHURNER, VOLUNTARIO, INVOLUNTARIO, MaxFecha, PrimerChurn, MesChurnF, MesChurnP,
EXTRACT(MONTH FROM s.FECHA_APERTURA ) AS MesS
FROM REALCHURNERS c INNER JOIN CHURNERSSOCLASIF s ON CONTRATOSO = CHURNER
AND c.PrimerChurn >= s.FECHA_APERTURA AND date_diff(c.PrimerChurn, s.FECHA_APERTURA, MONTH) <= 3
GROUP BY contratoso, CHURNER, MesS, VOLUNTARIO, INVOLUNTARIO, MaxFecha, PrimerChurn, MesChurnF, MesChurnP
),
PLANCHURNERS AS(
      SELECT DISTINCT RIGHT(CONCAT('0000000000',ACT_ACCT_CD) ,10) AS CONTRATOPLAN
    , MIN(DATE(CST_CHRN_DT)) AS MinfechaP,
    CASE
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NOT NULL THEN "3P"
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NULL THEN "2P - BB+TV"
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NULL AND PD_VO_PROD_ID IS NOT NULL THEN "2P - BB+VO"
    WHEN  PD_BB_PROD_ID IS NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NOT NULL THEN "2P - TV+VO"
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NULL AND PD_VO_PROD_ID IS NULL THEN "1P - BB"
    WHEN  PD_BB_PROD_ID IS NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NULL THEN "1P - TV"
    WHEN  PD_BB_PROD_ID IS NULL AND PD_TV_PROD_ID IS NULL AND PD_VO_PROD_ID IS NOT NULL THEN "1P - VO"
    END AS PFLAG
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-16_FINAL_HISTORIC_CRM_FILE_2021_D`
    GROUP BY ACT_ACCT_CD, PFLAG
    HAVING extract(YEAR FROM MinfechaP) = 2021
),
CRUCEPLANCHURN AS
(
 SELECT DISTINCT c.CONTRATOSO,c.maxFecha, c.PrimerChurn, p.Pflag, min(date(t.ACT_ACCT_INST_DT)) as MinInst, C_CUST_AGE,c.Voluntario, c.Involuntario
 FROM CRUCECHURNERS  c INNER JOIN PLANCHURNERS p on C.CONTRATOSO = p.CONTRATOPLAN AND c.PrimerChurn = p.MinFechaP
 INNER JOIN `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-16_FINAL_HISTORIC_CRM_FILE_2021_D` t
 ON c.CONTRATOSO = RIGHT(CONCAT('0000000000',T.ACT_ACCT_CD) ,10) AND c.Maxfecha = DATE(t.CST_CHRN_DT)
 GROUP BY c.CONTRATOSO, c.Maxfecha, c.PrimerChurn,p.PFLAG, c.PrimerChurn, C_CUST_AGE,Voluntario, Involuntario
),
TENURECHURN AS(
    SELECT DISTINCT C.CONTRATOSO, c.MaxFecha,C.PrimerChurn, Pflag,c.Voluntario, c.Involuntario,
 CASE   WHEN MAX(C_CUST_AGE) <= 1 THEN "1M"
        WHEN MAX(C_CUST_AGE) > 1 AND MAX(C_CUST_AGE) <= 2 THEN "1M-2M"
        WHEN MAX(C_CUST_AGE) > 2 AND MAX(C_CUST_AGE) <= 3 THEN "2M-3M"
        WHEN MAX(C_CUST_AGE) > 3 AND MAX(C_CUST_AGE) <= 4 THEN "3M-4M"
        WHEN MAX(C_CUST_AGE) > 4 AND MAX(C_CUST_AGE) <= 5 THEN "4M-5M"
        WHEN MAX(C_CUST_AGE) > 5 AND MAX(C_CUST_AGE) <= 6 THEN "5M-6M"
        WHEN MAX(C_CUST_AGE) > 6 AND MAX(C_CUST_AGE) <= 7 THEN "6M-7M"
        WHEN MAX(C_CUST_AGE) > 7 AND MAX(C_CUST_AGE) <= 8 THEN "7M-8M"
        WHEN MAX(C_CUST_AGE) > 8 AND MAX(C_CUST_AGE) <= 9 THEN "8M-9M"
        WHEN MAX(C_CUST_AGE) > 9 AND MAX(C_CUST_AGE) <= 10 THEN "9M-10M"
        WHEN MAX(C_CUST_AGE) > 10 AND MAX(C_CUST_AGE) <= 11 THEN "10M-11M"
        WHEN MAX(C_CUST_AGE) > 11 AND MAX(C_CUST_AGE) <= 12 THEN "11M-1Y"
        WHEN MAX(C_CUST_AGE) > 12 AND MAX(C_CUST_AGE) <= 24 THEN "1Y-2Y"
        WHEN MAX(C_CUST_AGE) > 24 THEN "2Y+"
        END AS TENURE
    FROM CRUCEPLANCHURN c
    GROUP BY C.CONTRATOSO, PFLAG, c.MaxFecha,c.PrimerChurn,Voluntario, Involuntario
)
SELECT DISTINCT EXTRACT (MONTH FROM MaxFecha) as MES, PFLAG
, TENURE, 
Count(DISTINCT CONTRATOSO) AS NumChurners,
COUNT(DISTINCT Voluntario) as ChurnersVol, COUNT (DISTINCT Involuntario) as ChurnersInvol
FROM TENURECHURN
GROUP BY MES, PFLAG, TENURE
ORDER BY MES, TENURE ASC
